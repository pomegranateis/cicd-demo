name: Advanced Security Matrix Demo

# This workflow demonstrates Exercise 4 & 5 concepts
# It's a simplified version for local testing

on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: "Type of security scan to run"
        required: true
        default: "dependencies"
        type: choice
        options:
          - dependencies
          - code
          - container
          - all

jobs:
  security-matrix-demo:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        scan-type: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.scan_type == 'all' && fromJson('["dependencies", "code", "container"]') || fromJson(format('["{0}"]', github.event.inputs.scan_type || 'dependencies')) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build project
        if: matrix.scan-type != 'code'
        run: mvn clean compile -DskipTests

      - name: Demo Security Scan - ${{ matrix.scan-type }}
        run: |
          echo "ðŸ” Running ${{ matrix.scan-type }} security scan..."
          echo "Scan type: ${{ matrix.scan-type }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

          # Simulate different scan types
          case "${{ matrix.scan-type }}" in
            "dependencies")
              echo "ðŸ“¦ Scanning Maven dependencies..."
              mvn dependency:tree
              echo "Would run: snyk test --maven --severity-threshold=medium"
              ;;
            "code")
              echo "ðŸ” Scanning source code..."
              find src -name "*.java" | head -5
              echo "Would run: snyk code test --severity-threshold=high"
              ;;
            "container")
              echo "ðŸ³ Scanning container image..."
              echo "Would run: docker build -t demo:latest ."
              echo "Would run: snyk container test demo:latest"
              ;;
          esac

      - name: Generate Security Report
        run: |
          echo "## Security Scan Report - ${{ matrix.scan-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Type**: ${{ matrix.scan-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY

          # Simulate vulnerability findings for demo
          if [ "${{ matrix.scan-type }}" = "dependencies" ]; then
            echo "- **Findings**: ðŸš¨ Vulnerable jackson-databind 2.9.8 detected" >> $GITHUB_STEP_SUMMARY
            echo "- **Recommendation**: Upgrade to jackson-databind 2.15.2+" >> $GITHUB_STEP_SUMMARY
          fi
