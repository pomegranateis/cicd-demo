name: Snyk Authentication Test

# This workflow helps debug Snyk authentication issues
# Trigger manually to test your SNYK_TOKEN setup

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: "Debug level (basic or verbose)"
        required: false
        default: "basic"
        type: choice
        options:
          - basic
          - verbose

jobs:
  snyk-auth-test:
    name: Test Snyk Authentication
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build project (required for Snyk Maven scan)
        run: mvn clean compile -q

      - name: Check Environment
        run: |
          echo "ðŸ” Environment Check"
          echo "Runner OS: ${{ runner.os }}"
          echo "Java version: $(java -version 2>&1 | head -1)"
          echo "Maven version: $(mvn -version | head -1)"
          echo "Working directory: $(pwd)"
          echo "Available files:"
          ls -la | head -10

      - name: Verify SNYK_TOKEN exists
        run: |
          echo "ðŸ” Checking SNYK_TOKEN configuration..."
          if [ -z "${{ secrets.SNYK_TOKEN }}" ]; then
            echo "âŒ SNYK_TOKEN secret is not set!"
            echo "ðŸ‘‰ Go to Settings â†’ Secrets and variables â†’ Actions"
            echo "ðŸ‘‰ Add a secret named 'SNYK_TOKEN' with your Snyk API token"
            exit 1
          else
            echo "âœ… SNYK_TOKEN secret is configured"
            echo "Token length: ${#SNYK_TOKEN} characters"
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Install Snyk CLI
        run: |
          echo "ðŸ“¦ Installing Snyk CLI..."
          npm install -g snyk@latest
          snyk --version

      - name: Test Snyk Authentication
        run: |
          echo "ðŸ”‘ Testing Snyk authentication..."
          snyk auth ${{ secrets.SNYK_TOKEN }}
          echo "âœ… Authentication successful!"

      - name: Test Snyk Version and Config
        run: |
          echo "ðŸ“‹ Snyk configuration:"
          snyk config list
          echo "ðŸ¢ Organization info:"
          snyk auth test 2>/dev/null || echo "Auth test completed"

      - name: Run Basic Snyk Test
        run: |
          echo "ðŸ” Running basic Snyk vulnerability test..."
          snyk test --maven --json > snyk-results.json 2>/dev/null || true

          # Check if we got results
          if [ -f snyk-results.json ] && [ -s snyk-results.json ]; then
            echo "âœ… Snyk scan completed successfully!"
            echo "ðŸ“Š Results summary:"
            cat snyk-results.json | jq -r '.summary // "No summary available"' 2>/dev/null || echo "Raw results available in snyk-results.json"
          else
            echo "â„¹ï¸ No results file generated, running simple test..."
            snyk test --maven --severity-threshold=low
          fi

      - name: Run Enhanced Test (if verbose)
        if: github.event.inputs.debug_level == 'verbose'
        run: |
          echo "ðŸ” Running enhanced Snyk scan..."
          snyk test --maven --all-projects --severity-threshold=medium --json || true

      - name: Test SARIF Generation
        run: |
          echo "ðŸ“„ Testing SARIF report generation..."
          snyk test --maven --sarif-file-output=snyk-test.sarif || true

          if [ -f snyk-test.sarif ]; then
            echo "âœ… SARIF report generated successfully!"
            echo "ðŸ“ SARIF file size: $(du -h snyk-test.sarif | cut -f1)"
            echo "ðŸ”¢ Number of results: $(cat snyk-test.sarif | jq '.runs[0].results | length' 2>/dev/null || echo "Unable to parse")"
          else
            echo "âš ï¸ SARIF file not generated - this might be normal if no vulnerabilities found"
          fi

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-test-results
          path: |
            snyk-*.json
            snyk-*.sarif
          retention-days: 5

      - name: Success Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Snyk Authentication Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Authentication**: Successful" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **CLI Installation**: Working" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Maven Integration**: Functional" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Vulnerability Scanning**: Operational" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- Your Snyk integration is ready!" >> $GITHUB_STEP_SUMMARY
          echo "- Run the main security workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Check Security tab for vulnerability findings" >> $GITHUB_STEP_SUMMARY

      - name: Failure Summary
        if: failure()
        run: |
          echo "## âŒ Snyk Authentication Test Failed" >> $GITHUB_STEP_SUMMARY
          echo "**Common Solutions:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify SNYK_TOKEN secret is properly set" >> $GITHUB_STEP_SUMMARY
          echo "2. Check token format (should be UUID-like)" >> $GITHUB_STEP_SUMMARY
          echo "3. Generate fresh token from https://snyk.io" >> $GITHUB_STEP_SUMMARY
          echo "4. Try re-running this workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š See snyk-troubleshooting.md for detailed help" >> $GITHUB_STEP_SUMMARY
